import { __assign, __decorate, __param, __read } from "tslib";
import { ComponentFactoryResolver, ComponentRef, Directive, ElementRef, Inject, Input, OnDestroy, OnInit, Optional, Self, TemplateRef, ViewContainerRef, EmbeddedViewRef } from '@angular/core';
import { AbstractControl, ControlContainer, NgControl, ValidationErrors } from '@angular/forms';
import { DefaultControlErrorComponent } from './control-error.component';
import { ControlErrorAnchorDirective } from './control-error-anchor.directive';
import { EMPTY, fromEvent, merge, NEVER, Subject } from 'rxjs';
import { ErrorTailorConfigProvider, FORM_ERRORS } from './providers';
import { distinctUntilChanged, mapTo, startWith, switchMap, takeUntil } from 'rxjs/operators';
import { FormActionDirective } from './form-action.directive';
var ControlErrorsDirective = /** @class */ (function () {
    function ControlErrorsDirective(vcr, resolver, host, config, globalErrors, controlErrorAnchorParent, form, ngControl, controlContainer) {
        this.vcr = vcr;
        this.resolver = resolver;
        this.host = host;
        this.config = config;
        this.globalErrors = globalErrors;
        this.controlErrorAnchorParent = controlErrorAnchorParent;
        this.form = form;
        this.ngControl = ngControl;
        this.controlContainer = controlContainer;
        this.customErrors = {};
        this.controlErrorsOnAsync = true;
        this.controlErrorsOnBlur = true;
        this.destroy = new Subject();
        this.showError$ = new Subject();
        this.mergedConfig = {};
        this.submit$ = this.form ? this.form.submit$ : EMPTY;
        this.reset$ = this.form ? this.form.reset$ : EMPTY;
        this.mergedConfig = this.buildConfig();
    }
    ControlErrorsDirective.prototype.ngOnInit = function () {
        var _this = this;
        this.anchor = this.resolveAnchor();
        this.control = (this.controlContainer || this.ngControl).control;
        var hasAsyncValidator = !!this.control.asyncValidator;
        var statusChanges$ = this.control.statusChanges.pipe(distinctUntilChanged());
        var valueChanges$ = this.control.valueChanges;
        var controlChanges$ = merge(statusChanges$, valueChanges$);
        var changesOnAsync$ = EMPTY;
        var changesOnBlur$ = EMPTY;
        if (this.controlErrorsOnAsync && hasAsyncValidator) {
            // hasAsyncThenUponStatusChange
            changesOnAsync$ = statusChanges$.pipe(startWith(true));
        }
        if (this.controlErrorsOnBlur && this.isInput) {
            var blur$ = fromEvent(this.host.nativeElement, 'focusout');
            // blurFirstThenUponChange
            changesOnBlur$ = blur$.pipe(switchMap(function () { return valueChanges$.pipe(startWith(true)); }));
        }
        var submit$ = merge(this.submit$.pipe(mapTo(true)), this.reset$.pipe(mapTo(false)));
        // when submitted, submitFirstThenUponChanges
        var changesOnSubmit$ = submit$.pipe(switchMap(function (submit) { return (submit ? controlChanges$.pipe(startWith(true)) : NEVER); }));
        // on reset, clear ComponentRef and customAnchorDestroyFn
        this.reset$.pipe(takeUntil(this.destroy)).subscribe(function () { return _this.clearRefs(); });
        merge(changesOnAsync$, changesOnBlur$, changesOnSubmit$, this.showError$)
            .pipe(takeUntil(this.destroy))
            .subscribe(function () { return _this.valueChanges(); });
    };
    ControlErrorsDirective.prototype.setError = function (text, error) {
        if (!this.ref) {
            var factory = this.resolver.resolveComponentFactory(this.mergedConfig.controlErrorComponent);
            this.ref = this.anchor.createComponent(factory);
        }
        var instance = this.ref.instance;
        if (this.controlErrorsTpl) {
            instance.createTemplate(this.controlErrorsTpl, error, text);
        }
        else {
            instance.text = text;
        }
        if (this.controlErrorsClass) {
            instance.customClass = this.controlErrorsClass;
        }
        if (!this.controlErrorAnchor && this.mergedConfig.controlErrorComponentAnchorFn) {
            this.customAnchorDestroyFn = this.mergedConfig.controlErrorComponentAnchorFn(this.host.nativeElement, this.ref.hostView.rootNodes[0]);
        }
    };
    /**
     * Explicit showing of a control error via some custom application code.
     */
    ControlErrorsDirective.prototype.showError = function () {
        this.showError$.next();
    };
    /**
     * Explicit hiding of a control error via some custom application code.
     */
    ControlErrorsDirective.prototype.hideError = function () {
        this.setError(null);
    };
    ControlErrorsDirective.prototype.ngOnDestroy = function () {
        this.destroy.next();
        this.clearRefs();
    };
    Object.defineProperty(ControlErrorsDirective.prototype, "isInput", {
        get: function () {
            return this.mergedConfig.blurPredicate(this.host.nativeElement);
        },
        enumerable: true,
        configurable: true
    });
    ControlErrorsDirective.prototype.clearRefs = function () {
        if (this.customAnchorDestroyFn) {
            this.customAnchorDestroyFn();
            this.customAnchorDestroyFn = null;
        }
        if (this.ref) {
            this.ref.destroy();
        }
        this.ref = null;
    };
    ControlErrorsDirective.prototype.valueChanges = function () {
        var controlErrors = this.control.errors;
        if (controlErrors) {
            var _a = __read(Object.keys(controlErrors), 1), firstKey = _a[0];
            var getError = this.customErrors[firstKey] || this.globalErrors[firstKey];
            if (!getError) {
                return;
            }
            var text = typeof getError === 'function' ? getError(controlErrors[firstKey]) : getError;
            if (this.isInput) {
                this.host.nativeElement.parentElement.classList.add('error-tailor-has-error');
            }
            this.setError(text, controlErrors);
        }
        else if (this.ref) {
            if (this.isInput) {
                this.host.nativeElement.parentElement.classList.remove('error-tailor-has-error');
            }
            this.setError(null);
        }
    };
    ControlErrorsDirective.prototype.resolveAnchor = function () {
        if (this.controlErrorAnchor) {
            return this.controlErrorAnchor.vcr;
        }
        if (this.controlErrorAnchorParent) {
            return this.controlErrorAnchorParent.vcr;
        }
        return this.vcr;
    };
    ControlErrorsDirective.prototype.buildConfig = function () {
        return __assign({
            blurPredicate: function (element) {
                return element.tagName === 'INPUT' || element.tagName === 'SELECT';
            },
            controlErrorComponent: DefaultControlErrorComponent
        }, this.config);
    };
    ControlErrorsDirective.ctorParameters = function () { return [
        { type: ViewContainerRef },
        { type: ComponentFactoryResolver },
        { type: ElementRef },
        { type: undefined, decorators: [{ type: Inject, args: [ErrorTailorConfigProvider,] }] },
        { type: undefined, decorators: [{ type: Inject, args: [FORM_ERRORS,] }] },
        { type: ControlErrorAnchorDirective, decorators: [{ type: Optional }] },
        { type: FormActionDirective, decorators: [{ type: Optional }] },
        { type: NgControl, decorators: [{ type: Optional }, { type: Self }] },
        { type: ControlContainer, decorators: [{ type: Optional }, { type: Self }] }
    ]; };
    __decorate([
        Input('controlErrors')
    ], ControlErrorsDirective.prototype, "customErrors", void 0);
    __decorate([
        Input()
    ], ControlErrorsDirective.prototype, "controlErrorsClass", void 0);
    __decorate([
        Input()
    ], ControlErrorsDirective.prototype, "controlErrorsTpl", void 0);
    __decorate([
        Input()
    ], ControlErrorsDirective.prototype, "controlErrorsOnAsync", void 0);
    __decorate([
        Input()
    ], ControlErrorsDirective.prototype, "controlErrorsOnBlur", void 0);
    __decorate([
        Input()
    ], ControlErrorsDirective.prototype, "controlErrorAnchor", void 0);
    ControlErrorsDirective = __decorate([
        Directive({
            selector: '[formControlName]:not([controlErrorsIgnore]), [formControl]:not([controlErrorsIgnore]), [formGroup]:not([controlErrorsIgnore]), [formGroupName]:not([controlErrorsIgnore]), [formArrayName]:not([controlErrorsIgnore]), [ngModel]:not([controlErrorsIgnore])',
            exportAs: 'errorTailor'
        }),
        __param(3, Inject(ErrorTailorConfigProvider)),
        __param(4, Inject(FORM_ERRORS)),
        __param(5, Optional()),
        __param(6, Optional()),
        __param(7, Optional()), __param(7, Self()),
        __param(8, Optional()), __param(8, Self())
    ], ControlErrorsDirective);
    return ControlErrorsDirective;
}());
export { ControlErrorsDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJvbC1lcnJvci5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AbmduZWF0L2Vycm9yLXRhaWxvci8iLCJzb3VyY2VzIjpbImxpYi9jb250cm9sLWVycm9yLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLHdCQUF3QixFQUN4QixZQUFZLEVBQ1osU0FBUyxFQUNULFVBQVUsRUFDVixNQUFNLEVBQ04sS0FBSyxFQUNMLFNBQVMsRUFDVCxNQUFNLEVBQ04sUUFBUSxFQUNSLElBQUksRUFDSixXQUFXLEVBQ1gsZ0JBQWdCLEVBQ2hCLGVBQWUsRUFDaEIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGVBQWUsRUFBRSxnQkFBZ0IsRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNoRyxPQUFPLEVBQUUsNEJBQTRCLEVBQXlCLE1BQU0sMkJBQTJCLENBQUM7QUFDaEcsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDL0UsT0FBTyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDM0UsT0FBTyxFQUFxQix5QkFBeUIsRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDeEYsT0FBTyxFQUFFLG9CQUFvQixFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBTyxNQUFNLGdCQUFnQixDQUFDO0FBQ25HLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBUTlEO0lBa0JFLGdDQUNVLEdBQXFCLEVBQ3JCLFFBQWtDLEVBQ2xDLElBQWdCLEVBQ21CLE1BQXlCLEVBQ3ZDLFlBQVksRUFDckIsd0JBQXFELEVBQ3JELElBQXlCLEVBQ2pCLFNBQW9CLEVBQ3BCLGdCQUFrQztRQVJ0RCxRQUFHLEdBQUgsR0FB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QUE7UUFDbkIsV0FBQSxRQUFRLEVBQUUsQ0FBQTtRQUNWLFdBQUEsUUFBUSxFQUFFLENBQUE7UUFDVixXQUFBLFFBQVEsRUFBRSxDQUFBLEVBQUUsV0FBQSxJQUFJLEVBQUUsQ0FBQTtRQUNsQixXQUFBLFFBQVEsRUFBRSxDQUFBLEVBQUUsV0FBQSxJQUFJLEVBQUUsQ0FBQTtPQTNCVixzQkFBc0IsQ0FnTGxDO0lBQUQsNkJBQUM7Q0FBQSxBQWhMRCxJQWdMQztTQWhMWSxzQkFBc0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gIENvbXBvbmVudFJlZixcbiAgRGlyZWN0aXZlLFxuICBFbGVtZW50UmVmLFxuICBJbmplY3QsXG4gIElucHV0LFxuICBPbkRlc3Ryb3ksXG4gIE9uSW5pdCxcbiAgT3B0aW9uYWwsXG4gIFNlbGYsXG4gIFRlbXBsYXRlUmVmLFxuICBWaWV3Q29udGFpbmVyUmVmLFxuICBFbWJlZGRlZFZpZXdSZWZcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBYnN0cmFjdENvbnRyb2wsIENvbnRyb2xDb250YWluZXIsIE5nQ29udHJvbCwgVmFsaWRhdGlvbkVycm9ycyB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IERlZmF1bHRDb250cm9sRXJyb3JDb21wb25lbnQsIENvbnRyb2xFcnJvckNvbXBvbmVudCB9IGZyb20gJy4vY29udHJvbC1lcnJvci5jb21wb25lbnQnO1xuaW1wb3J0IHsgQ29udHJvbEVycm9yQW5jaG9yRGlyZWN0aXZlIH0gZnJvbSAnLi9jb250cm9sLWVycm9yLWFuY2hvci5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgRU1QVFksIGZyb21FdmVudCwgbWVyZ2UsIE5FVkVSLCBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBFcnJvclRhaWxvckNvbmZpZywgRXJyb3JUYWlsb3JDb25maWdQcm92aWRlciwgRk9STV9FUlJPUlMgfSBmcm9tICcuL3Byb3ZpZGVycyc7XG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgbWFwVG8sIHN0YXJ0V2l0aCwgc3dpdGNoTWFwLCB0YWtlVW50aWwsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEZvcm1BY3Rpb25EaXJlY3RpdmUgfSBmcm9tICcuL2Zvcm0tYWN0aW9uLmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBFcnJvcnNNYXAgfSBmcm9tICcuL3R5cGVzJztcblxuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOlxuICAgICdbZm9ybUNvbnRyb2xOYW1lXTpub3QoW2NvbnRyb2xFcnJvcnNJZ25vcmVdKSwgW2Zvcm1Db250cm9sXTpub3QoW2NvbnRyb2xFcnJvcnNJZ25vcmVdKSwgW2Zvcm1Hcm91cF06bm90KFtjb250cm9sRXJyb3JzSWdub3JlXSksIFtmb3JtR3JvdXBOYW1lXTpub3QoW2NvbnRyb2xFcnJvcnNJZ25vcmVdKSwgW2Zvcm1BcnJheU5hbWVdOm5vdChbY29udHJvbEVycm9yc0lnbm9yZV0pLCBbbmdNb2RlbF06bm90KFtjb250cm9sRXJyb3JzSWdub3JlXSknLFxuICBleHBvcnRBczogJ2Vycm9yVGFpbG9yJ1xufSlcbmV4cG9ydCBjbGFzcyBDb250cm9sRXJyb3JzRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuICBASW5wdXQoJ2NvbnRyb2xFcnJvcnMnKSBjdXN0b21FcnJvcnM6IEVycm9yc01hcCA9IHt9O1xuICBASW5wdXQoKSBjb250cm9sRXJyb3JzQ2xhc3M6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgQElucHV0KCkgY29udHJvbEVycm9yc1RwbDogVGVtcGxhdGVSZWY8YW55PiB8IHVuZGVmaW5lZDtcbiAgQElucHV0KCkgY29udHJvbEVycm9yc09uQXN5bmMgPSB0cnVlO1xuICBASW5wdXQoKSBjb250cm9sRXJyb3JzT25CbHVyID0gdHJ1ZTtcbiAgQElucHV0KCkgY29udHJvbEVycm9yQW5jaG9yOiBDb250cm9sRXJyb3JBbmNob3JEaXJlY3RpdmU7XG5cbiAgcHJpdmF0ZSByZWY6IENvbXBvbmVudFJlZjxDb250cm9sRXJyb3JDb21wb25lbnQ+O1xuICBwcml2YXRlIGFuY2hvcjogVmlld0NvbnRhaW5lclJlZjtcbiAgcHJpdmF0ZSBzdWJtaXQkOiBPYnNlcnZhYmxlPEV2ZW50PjtcbiAgcHJpdmF0ZSByZXNldCQ6IE9ic2VydmFibGU8RXZlbnQ+O1xuICBwcml2YXRlIGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbDtcbiAgcHJpdmF0ZSBkZXN0cm95ID0gbmV3IFN1YmplY3QoKTtcbiAgcHJpdmF0ZSBzaG93RXJyb3IkID0gbmV3IFN1YmplY3QoKTtcbiAgcHJpdmF0ZSBtZXJnZWRDb25maWc6IEVycm9yVGFpbG9yQ29uZmlnID0ge307XG4gIHByaXZhdGUgY3VzdG9tQW5jaG9yRGVzdHJveUZuOiAoKSA9PiB2b2lkO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgdmNyOiBWaWV3Q29udGFpbmVyUmVmLFxuICAgIHByaXZhdGUgcmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgICBwcml2YXRlIGhvc3Q6IEVsZW1lbnRSZWYsXG4gICAgQEluamVjdChFcnJvclRhaWxvckNvbmZpZ1Byb3ZpZGVyKSBwcml2YXRlIGNvbmZpZzogRXJyb3JUYWlsb3JDb25maWcsXG4gICAgQEluamVjdChGT1JNX0VSUk9SUykgcHJpdmF0ZSBnbG9iYWxFcnJvcnMsXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBjb250cm9sRXJyb3JBbmNob3JQYXJlbnQ6IENvbnRyb2xFcnJvckFuY2hvckRpcmVjdGl2ZSxcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGZvcm06IEZvcm1BY3Rpb25EaXJlY3RpdmUsXG4gICAgQE9wdGlvbmFsKCkgQFNlbGYoKSBwcml2YXRlIG5nQ29udHJvbDogTmdDb250cm9sLFxuICAgIEBPcHRpb25hbCgpIEBTZWxmKCkgcHJpdmF0ZSBjb250cm9sQ29udGFpbmVyOiBDb250cm9sQ29udGFpbmVyXG4gICkge1xuICAgIHRoaXMuc3VibWl0JCA9IHRoaXMuZm9ybSA/IHRoaXMuZm9ybS5zdWJtaXQkIDogRU1QVFk7XG4gICAgdGhpcy5yZXNldCQgPSB0aGlzLmZvcm0gPyB0aGlzLmZvcm0ucmVzZXQkIDogRU1QVFk7XG4gICAgdGhpcy5tZXJnZWRDb25maWcgPSB0aGlzLmJ1aWxkQ29uZmlnKCk7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmFuY2hvciA9IHRoaXMucmVzb2x2ZUFuY2hvcigpO1xuICAgIHRoaXMuY29udHJvbCA9ICh0aGlzLmNvbnRyb2xDb250YWluZXIgfHwgdGhpcy5uZ0NvbnRyb2wpLmNvbnRyb2w7XG4gICAgY29uc3QgaGFzQXN5bmNWYWxpZGF0b3IgPSAhIXRoaXMuY29udHJvbC5hc3luY1ZhbGlkYXRvcjtcblxuICAgIGNvbnN0IHN0YXR1c0NoYW5nZXMkID0gdGhpcy5jb250cm9sLnN0YXR1c0NoYW5nZXMucGlwZShkaXN0aW5jdFVudGlsQ2hhbmdlZCgpKTtcbiAgICBjb25zdCB2YWx1ZUNoYW5nZXMkID0gdGhpcy5jb250cm9sLnZhbHVlQ2hhbmdlcztcbiAgICBjb25zdCBjb250cm9sQ2hhbmdlcyQgPSBtZXJnZShzdGF0dXNDaGFuZ2VzJCwgdmFsdWVDaGFuZ2VzJCk7XG4gICAgbGV0IGNoYW5nZXNPbkFzeW5jJDogT2JzZXJ2YWJsZTxhbnk+ID0gRU1QVFk7XG4gICAgbGV0IGNoYW5nZXNPbkJsdXIkOiBPYnNlcnZhYmxlPGFueT4gPSBFTVBUWTtcblxuICAgIGlmICh0aGlzLmNvbnRyb2xFcnJvcnNPbkFzeW5jICYmIGhhc0FzeW5jVmFsaWRhdG9yKSB7XG4gICAgICAvLyBoYXNBc3luY1RoZW5VcG9uU3RhdHVzQ2hhbmdlXG4gICAgICBjaGFuZ2VzT25Bc3luYyQgPSBzdGF0dXNDaGFuZ2VzJC5waXBlKHN0YXJ0V2l0aCh0cnVlKSk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuY29udHJvbEVycm9yc09uQmx1ciAmJiB0aGlzLmlzSW5wdXQpIHtcbiAgICAgIGNvbnN0IGJsdXIkID0gZnJvbUV2ZW50KHRoaXMuaG9zdC5uYXRpdmVFbGVtZW50LCAnZm9jdXNvdXQnKTtcbiAgICAgIC8vIGJsdXJGaXJzdFRoZW5VcG9uQ2hhbmdlXG4gICAgICBjaGFuZ2VzT25CbHVyJCA9IGJsdXIkLnBpcGUoc3dpdGNoTWFwKCgpID0+IHZhbHVlQ2hhbmdlcyQucGlwZShzdGFydFdpdGgodHJ1ZSkpKSk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3VibWl0JCA9IG1lcmdlKHRoaXMuc3VibWl0JC5waXBlKG1hcFRvKHRydWUpKSwgdGhpcy5yZXNldCQucGlwZShtYXBUbyhmYWxzZSkpKTtcblxuICAgIC8vIHdoZW4gc3VibWl0dGVkLCBzdWJtaXRGaXJzdFRoZW5VcG9uQ2hhbmdlc1xuICAgIGNvbnN0IGNoYW5nZXNPblN1Ym1pdCQgPSBzdWJtaXQkLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAoc3VibWl0ID0+IChzdWJtaXQgPyBjb250cm9sQ2hhbmdlcyQucGlwZShzdGFydFdpdGgodHJ1ZSkpIDogTkVWRVIpKVxuICAgICk7XG5cbiAgICAvLyBvbiByZXNldCwgY2xlYXIgQ29tcG9uZW50UmVmIGFuZCBjdXN0b21BbmNob3JEZXN0cm95Rm5cbiAgICB0aGlzLnJlc2V0JC5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kpKS5zdWJzY3JpYmUoKCkgPT4gdGhpcy5jbGVhclJlZnMoKSk7XG5cbiAgICBtZXJnZShjaGFuZ2VzT25Bc3luYyQsIGNoYW5nZXNPbkJsdXIkLCBjaGFuZ2VzT25TdWJtaXQkLCB0aGlzLnNob3dFcnJvciQpXG4gICAgICAucGlwZSh0YWtlVW50aWwodGhpcy5kZXN0cm95KSlcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4gdGhpcy52YWx1ZUNoYW5nZXMoKSk7XG4gIH1cblxuICBwcml2YXRlIHNldEVycm9yKHRleHQ6IHN0cmluZywgZXJyb3I/OiBWYWxpZGF0aW9uRXJyb3JzKSB7XG4gICAgaWYgKCF0aGlzLnJlZikge1xuICAgICAgY29uc3QgZmFjdG9yeSA9IHRoaXMucmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3Rvcnk8Q29udHJvbEVycm9yQ29tcG9uZW50PihcbiAgICAgICAgdGhpcy5tZXJnZWRDb25maWcuY29udHJvbEVycm9yQ29tcG9uZW50XG4gICAgICApO1xuICAgICAgdGhpcy5yZWYgPSB0aGlzLmFuY2hvci5jcmVhdGVDb21wb25lbnQ8Q29udHJvbEVycm9yQ29tcG9uZW50PihmYWN0b3J5KTtcbiAgICB9XG4gICAgY29uc3QgaW5zdGFuY2UgPSB0aGlzLnJlZi5pbnN0YW5jZTtcblxuICAgIGlmICh0aGlzLmNvbnRyb2xFcnJvcnNUcGwpIHtcbiAgICAgIGluc3RhbmNlLmNyZWF0ZVRlbXBsYXRlKHRoaXMuY29udHJvbEVycm9yc1RwbCwgZXJyb3IsIHRleHQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpbnN0YW5jZS50ZXh0ID0gdGV4dDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5jb250cm9sRXJyb3JzQ2xhc3MpIHtcbiAgICAgIGluc3RhbmNlLmN1c3RvbUNsYXNzID0gdGhpcy5jb250cm9sRXJyb3JzQ2xhc3M7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLmNvbnRyb2xFcnJvckFuY2hvciAmJiB0aGlzLm1lcmdlZENvbmZpZy5jb250cm9sRXJyb3JDb21wb25lbnRBbmNob3JGbikge1xuICAgICAgdGhpcy5jdXN0b21BbmNob3JEZXN0cm95Rm4gPSB0aGlzLm1lcmdlZENvbmZpZy5jb250cm9sRXJyb3JDb21wb25lbnRBbmNob3JGbihcbiAgICAgICAgdGhpcy5ob3N0Lm5hdGl2ZUVsZW1lbnQgYXMgSFRNTEVsZW1lbnQsXG4gICAgICAgICh0aGlzLnJlZi5ob3N0VmlldyBhcyBFbWJlZGRlZFZpZXdSZWY8YW55Pikucm9vdE5vZGVzWzBdIGFzIEhUTUxFbGVtZW50XG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBFeHBsaWNpdCBzaG93aW5nIG9mIGEgY29udHJvbCBlcnJvciB2aWEgc29tZSBjdXN0b20gYXBwbGljYXRpb24gY29kZS5cbiAgICovXG4gIHNob3dFcnJvcigpOiB2b2lkIHtcbiAgICB0aGlzLnNob3dFcnJvciQubmV4dCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4cGxpY2l0IGhpZGluZyBvZiBhIGNvbnRyb2wgZXJyb3IgdmlhIHNvbWUgY3VzdG9tIGFwcGxpY2F0aW9uIGNvZGUuXG4gICAqL1xuICBoaWRlRXJyb3IoKTogdm9pZCB7XG4gICAgdGhpcy5zZXRFcnJvcihudWxsKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuZGVzdHJveS5uZXh0KCk7XG4gICAgdGhpcy5jbGVhclJlZnMoKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IGlzSW5wdXQoKSB7XG4gICAgcmV0dXJuIHRoaXMubWVyZ2VkQ29uZmlnLmJsdXJQcmVkaWNhdGUodGhpcy5ob3N0Lm5hdGl2ZUVsZW1lbnQpO1xuICB9XG5cbiAgcHJpdmF0ZSBjbGVhclJlZnMoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuY3VzdG9tQW5jaG9yRGVzdHJveUZuKSB7XG4gICAgICB0aGlzLmN1c3RvbUFuY2hvckRlc3Ryb3lGbigpO1xuICAgICAgdGhpcy5jdXN0b21BbmNob3JEZXN0cm95Rm4gPSBudWxsO1xuICAgIH1cbiAgICBpZiAodGhpcy5yZWYpIHtcbiAgICAgIHRoaXMucmVmLmRlc3Ryb3koKTtcbiAgICB9XG4gICAgdGhpcy5yZWYgPSBudWxsO1xuICB9XG5cbiAgcHJpdmF0ZSB2YWx1ZUNoYW5nZXMoKSB7XG4gICAgY29uc3QgY29udHJvbEVycm9ycyA9IHRoaXMuY29udHJvbC5lcnJvcnM7XG4gICAgaWYgKGNvbnRyb2xFcnJvcnMpIHtcbiAgICAgIGNvbnN0IFtmaXJzdEtleV0gPSBPYmplY3Qua2V5cyhjb250cm9sRXJyb3JzKTtcbiAgICAgIGNvbnN0IGdldEVycm9yID0gdGhpcy5jdXN0b21FcnJvcnNbZmlyc3RLZXldIHx8IHRoaXMuZ2xvYmFsRXJyb3JzW2ZpcnN0S2V5XTtcbiAgICAgIGlmICghZ2V0RXJyb3IpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB0ZXh0ID0gdHlwZW9mIGdldEVycm9yID09PSAnZnVuY3Rpb24nID8gZ2V0RXJyb3IoY29udHJvbEVycm9yc1tmaXJzdEtleV0pIDogZ2V0RXJyb3I7XG4gICAgICBpZiAodGhpcy5pc0lucHV0KSB7XG4gICAgICAgIHRoaXMuaG9zdC5uYXRpdmVFbGVtZW50LnBhcmVudEVsZW1lbnQuY2xhc3NMaXN0LmFkZCgnZXJyb3ItdGFpbG9yLWhhcy1lcnJvcicpO1xuICAgICAgfVxuICAgICAgdGhpcy5zZXRFcnJvcih0ZXh0LCBjb250cm9sRXJyb3JzKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMucmVmKSB7XG4gICAgICBpZiAodGhpcy5pc0lucHV0KSB7XG4gICAgICAgIHRoaXMuaG9zdC5uYXRpdmVFbGVtZW50LnBhcmVudEVsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZSgnZXJyb3ItdGFpbG9yLWhhcy1lcnJvcicpO1xuICAgICAgfVxuICAgICAgdGhpcy5zZXRFcnJvcihudWxsKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlc29sdmVBbmNob3IoKSB7XG4gICAgaWYgKHRoaXMuY29udHJvbEVycm9yQW5jaG9yKSB7XG4gICAgICByZXR1cm4gdGhpcy5jb250cm9sRXJyb3JBbmNob3IudmNyO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmNvbnRyb2xFcnJvckFuY2hvclBhcmVudCkge1xuICAgICAgcmV0dXJuIHRoaXMuY29udHJvbEVycm9yQW5jaG9yUGFyZW50LnZjcjtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudmNyO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZENvbmZpZygpOiBFcnJvclRhaWxvckNvbmZpZyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLntcbiAgICAgICAgYmx1clByZWRpY2F0ZShlbGVtZW50KSB7XG4gICAgICAgICAgcmV0dXJuIGVsZW1lbnQudGFnTmFtZSA9PT0gJ0lOUFVUJyB8fCBlbGVtZW50LnRhZ05hbWUgPT09ICdTRUxFQ1QnO1xuICAgICAgICB9LFxuICAgICAgICBjb250cm9sRXJyb3JDb21wb25lbnQ6IERlZmF1bHRDb250cm9sRXJyb3JDb21wb25lbnRcbiAgICAgIH0sXG4gICAgICAuLi50aGlzLmNvbmZpZ1xuICAgIH07XG4gIH1cbn1cbiJdfQ==